---
- name: Safely deploy compare-app on Kubernetes with readiness check and rollback
  hosts: localhost
  vars:
    app_name: compare-app
    namespace: default
    image_name: basmaoueslati/compare-app
    version: "{{ NEXT_VERSION }}"
  tasks:

    - name: Check if deployment exists
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: "{{ app_name }}"
        namespace: "{{ namespace }}"
      register: deployment_info
      ignore_errors: true

    - name: Set flag if deployment exists
      set_fact:
        deployment_exists: "{{ deployment_info.resources | length > 0 }}"

    - name: Deploy new application if not exists
      when: not deployment_exists
      kubernetes.core.k8s:
        state: present
        namespace: "{{ namespace }}"
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: "{{ app_name }}"
          spec:
            replicas: 3
            selector:
              matchLabels:
                app: "{{ app_name }}"
            template:
              metadata:
                labels:
                  app: "{{ app_name }}"
                  version: "{{ version }}"
              spec:
                containers:
                  - name: "{{ app_name }}"
                    image: "{{ image_name }}:{{ version }}"
                    ports:
                      - containerPort: 8080

    - name: Patch deployment with new image (if exists)
      when: deployment_exists
      kubernetes.core.k8s:
        state: present
        kind: Deployment
        namespace: "{{ namespace }}"
        name: "{{ app_name }}"
        merge_type: strategic
        definition:
          spec:
            template:
              metadata:
                labels:
                  version: "{{ version }}"
              spec:
                containers:
                  - name: "{{ app_name }}"
                    image: "{{ image_name }}:{{ version }}"

    - name: Wait for rollout to complete
      retries: 10
      delay: 10
      until: rollout_status.resources[0].status.conditions[?(@.type=="Available")].status | first == "True"
      block:
        - name: Get updated deployment status
          kubernetes.core.k8s_info:
            api_version: apps/v1
            kind: Deployment
            name: "{{ app_name }}"
            namespace: "{{ namespace }}"
          register: rollout_status
